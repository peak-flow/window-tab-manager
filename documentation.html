<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Window & Tab Manager - Technical Documentation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: #1a73e8;
      color: white;
      padding: 40px 0;
      text-align: center;
      margin-bottom: 40px;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h2 {
      color: #1a73e8;
      margin-bottom: 20px;
      font-size: 1.8em;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }
    
    h3 {
      color: #333;
      margin: 25px 0 15px 0;
      font-size: 1.3em;
    }
    
    h4 {
      color: #5f6368;
      margin: 20px 0 10px 0;
      font-size: 1.1em;
    }
    
    pre {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
      margin: 15px 0;
    }
    
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
    }
    
    pre code {
      background: none;
      padding: 0;
    }
    
    .code-block {
      position: relative;
      margin: 20px 0;
    }
    
    .code-label {
      position: absolute;
      top: -10px;
      right: 10px;
      background: #1a73e8;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .diagram {
      background: #f8f9fa;
      border: 2px dashed #dadce0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      font-family: monospace;
    }
    
    .flow-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    .flow-box {
      background: #e8f0fe;
      border: 2px solid #1a73e8;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
    }
    
    .flow-arrow {
      font-size: 24px;
      color: #1a73e8;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .feature-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .feature-card h4 {
      color: #1a73e8;
      margin-bottom: 10px;
    }
    
    .highlight {
      background: #fff3cd;
      padding: 15px;
      border-left: 4px solid #ffc107;
      margin: 20px 0;
    }
    
    .warning {
      background: #f8d7da;
      padding: 15px;
      border-left: 4px solid #dc3545;
      margin: 20px 0;
    }
    
    .success {
      background: #d4edda;
      padding: 15px;
      border-left: 4px solid #28a745;
      margin: 20px 0;
    }
    
    ul, ol {
      margin: 15px 0 15px 30px;
    }
    
    li {
      margin: 8px 0;
    }
    
    .toc {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .toc h3 {
      margin-top: 0;
      color: #1a73e8;
    }
    
    .toc ul {
      list-style: none;
      margin-left: 0;
    }
    
    .toc a {
      color: #1a73e8;
      text-decoration: none;
      display: block;
      padding: 5px 0;
    }
    
    .toc a:hover {
      text-decoration: underline;
    }
    
    .visual-example {
      background: #f8f9fa;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .tab-demo {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 6px;
      margin: 10px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tab-favicon {
      width: 20px;
      height: 20px;
      background: #4285f4;
      border-radius: 3px;
      margin-right: 12px;
    }
    
    .tab-info {
      flex: 1;
    }
    
    .tab-title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .tab-url {
      font-size: 0.85em;
      color: #5f6368;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Window & Tab Manager</h1>
      <p class="subtitle">Technical Documentation - How the Manager Page Works</p>
    </div>
  </header>

  <div class="container">
    <!-- Table of Contents -->
    <div class="section toc">
      <h3>Table of Contents</h3>
      <ul>
        <li><a href="#overview">1. Overview</a></li>
        <li><a href="#architecture">2. Architecture Flow</a></li>
        <li><a href="#initialization">3. Page Initialization</a></li>
        <li><a href="#data-loading">4. Loading Windows & Tabs</a></li>
        <li><a href="#rendering">5. Rendering Process</a></li>
        <li><a href="#drag-drop">6. Drag & Drop Implementation</a></li>
        <li><a href="#event-handling">7. Event Handling</a></li>
        <li><a href="#real-time-updates">8. Real-time Updates</a></li>
        <li><a href="#security">9. Security Features</a></li>
      </ul>
    </div>

    <!-- Overview Section -->
    <div class="section" id="overview">
      <h2>1. Overview</h2>
      <p>The Window & Tab Manager page is a full-screen interface that displays all browser windows and tabs in a visual grid layout. It allows users to manage their browsing session through drag-and-drop operations and quick actions.</p>
      
      <div class="feature-grid">
        <div class="feature-card">
          <h4>ü™ü Window Cards</h4>
          <p>Each browser window is displayed as a card containing all its tabs</p>
        </div>
        <div class="feature-card">
          <h4>üîÑ Drag & Drop</h4>
          <p>Tabs can be dragged between windows to reorganize</p>
        </div>
        <div class="feature-card">
          <h4>‚ö° Real-time Updates</h4>
          <p>UI automatically updates when tabs/windows change</p>
        </div>
      </div>
    </div>

    <!-- Architecture Flow -->
    <div class="section" id="architecture">
      <h2>2. Architecture Flow</h2>
      <p>The manager page follows a clear data flow pattern:</p>
      
      <div class="diagram">
        <div class="flow-diagram">
          <div class="flow-box">User Action</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-box">manager.js</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-box">Message to Background</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-box">Chrome API</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-box">Browser State Change</div>
        </div>
      </div>

      <h3>Key Components:</h3>
      <ul>
        <li><code>manager.html</code> - The page structure and layout</li>
        <li><code>manager.js</code> - The WindowManager class that controls everything</li>
        <li><code>background.js</code> - Service worker that handles Chrome API calls</li>
        <li><code>manager.css</code> - Styling for the visual interface</li>
      </ul>
    </div>

    <!-- Page Initialization -->
    <div class="section" id="initialization">
      <h2>3. Page Initialization</h2>
      <p>When the manager page loads, it initializes the <code>WindowManager</code> class:</p>

      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>// This runs when the page loads
document.addEventListener('DOMContentLoaded', () => {
  new WindowManager();
});

class WindowManager {
  constructor() {
    this.windows = [];        // Stores all window data
    this.dragData = null;     // Tracks dragged tab info
    this.viewMode = 'grid';   // Layout mode
    
    this.initializeElements();   // Step 1: Cache DOM elements
    this.setupEventListeners();  // Step 2: Attach event handlers
    this.loadWindows();         // Step 3: Load browser data
  }
}</code></pre>
      </div>

      <h3>Step 1: Element Initialization</h3>
      <pre><code>initializeElements() {
  this.elements = {
    loading: document.getElementById('loading'),
    error: document.getElementById('error'),
    content: document.getElementById('content'),
    windowsContainer: document.getElementById('windowsContainer'),
    // ... and many more
  };
}</code></pre>

      <div class="highlight">
        <strong>üí° Performance Tip:</strong> All DOM elements are cached at startup to avoid repeated <code>querySelector</code> calls during runtime.
      </div>
    </div>

    <!-- Data Loading -->
    <div class="section" id="data-loading">
      <h2>4. Loading Windows & Tabs</h2>
      <p>The manager requests window data from the background script:</p>

      <h3>Request Flow:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>async loadWindows() {
  try {
    // Show loading spinner
    this.showLoading();
    
    // Request all windows from background script
    const response = await this.sendMessage({ action: 'getAllWindows' });
    
    if (response.error) {
      throw new Error(response.error);
    }
    
    // Store the data
    this.windows = response.windows || [];
    
    // Render the UI
    this.renderWindows();
    this.updateStats();
    this.showContent();
    
  } catch (error) {
    this.showError(error.message);
  }
}</code></pre>
      </div>

      <h3>Background Script Processing:</h3>
      <div class="code-block">
        <span class="code-label">background.js</span>
        <pre><code>async getAllWindows(sendResponse) {
  try {
    // Get all browser windows with their tabs
    const windows = await chrome.windows.getAll({
      populate: true,        // Include tab information
      windowTypes: ['normal'] // Only normal windows (not devtools, etc.)
    });
    
    // Clean and format the data
    const cleanWindows = windows.map(window => ({
      id: window.id,
      focused: window.focused,
      type: window.type,
      state: window.state,
      tabs: window.tabs.map(tab => ({
        id: tab.id,
        windowId: tab.windowId,
        index: tab.index,
        url: tab.url,
        title: tab.title,
        favIconUrl: tab.favIconUrl,
        active: tab.active,
        pinned: tab.pinned,
        audible: tab.audible,
        mutedInfo: tab.mutedInfo
      }))
    }));
    
    sendResponse({ success: true, windows: cleanWindows });
  } catch (error) {
    sendResponse({ error: error.message });
  }
}</code></pre>
      </div>

      <div class="visual-example">
        <h4>Example Data Structure:</h4>
        <pre><code>{
  "windows": [
    {
      "id": 1,
      "focused": true,
      "tabs": [
        {
          "id": 123,
          "title": "Google Search",
          "url": "https://www.google.com",
          "favIconUrl": "https://www.google.com/favicon.ico",
          "active": true,
          "pinned": false
        },
        {
          "id": 124,
          "title": "GitHub",
          "url": "https://github.com",
          "favIconUrl": "https://github.com/favicon.ico",
          "active": false,
          "pinned": true
        }
      ]
    }
  ]
}</code></pre>
      </div>
    </div>

    <!-- Rendering Process -->
    <div class="section" id="rendering">
      <h2>5. Rendering Process</h2>
      <p>The rendering process transforms the window data into visual HTML elements:</p>

      <h3>Main Render Function:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>renderWindows() {
  // Clear existing content
  this.elements.windowsContainer.innerHTML = '';
  
  // Check if any windows exist
  if (this.windows.length === 0) {
    this.elements.windowsContainer.innerHTML = `
      &lt;div class="empty-state"&gt;
        &lt;h2&gt;No windows found&lt;/h2&gt;
        &lt;p&gt;Click "New Window" to create one&lt;/p&gt;
      &lt;/div&gt;
    `;
    return;
  }
  
  // Create a card for each window
  this.windows.forEach((window, index) => {
    const windowElement = this.createWindowElement(window, index);
    this.elements.windowsContainer.appendChild(windowElement);
  });
}</code></pre>
      </div>

      <h3>Creating Window Cards:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>createWindowElement(window, index) {
  const windowDiv = document.createElement('div');
  windowDiv.className = `window-card ${window.focused ? 'focused' : ''}`;
  windowDiv.dataset.windowId = window.id;
  
  const windowTitle = this.getWindowTitle(window, index);
  
  // Generate HTML for all tabs
  const tabsHtml = window.tabs.length > 0 
    ? window.tabs.map(tab => this.createTabHTML(tab)).join('') 
    : '&lt;div class="empty-tabs"&gt;No tabs&lt;/div&gt;';
  
  // Build the window card HTML
  windowDiv.innerHTML = `
    &lt;div class="window-header"&gt;
      &lt;span class="window-title"&gt;${this.escapeHtml(windowTitle)}&lt;/span&gt;
      &lt;div class="window-actions"&gt;
        &lt;button class="window-btn focus-window-btn" 
                data-window-id="${window.id}"&gt;
          Focus
        &lt;/button&gt;
        &lt;button class="window-btn close-window-btn" 
                data-window-id="${window.id}"&gt;
          Close
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="tabs-container"&gt;
      ${tabsHtml}
    &lt;/div&gt;
  `;
  
  // Attach event listeners
  this.setupWindowEventListeners(windowDiv);
  
  return windowDiv;
}</code></pre>
      </div>

      <h3>Creating Individual Tabs:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>createTabHTML(tab) {
  // Use Chrome's favicon service or fallback
  const faviconUrl = tab.favIconUrl || 
    `chrome://favicon/size/16@2x/${encodeURIComponent(tab.url)}`;
  
  const tabTitle = tab.title || 'Untitled';
  const displayUrl = this.getDisplayUrl(tab.url); // Extract hostname
  
  // Build status indicators
  const indicators = [];
  if (tab.audible) {
    indicators.push('&lt;span class="tab-indicator tab-audible"&gt;üîä&lt;/span&gt;');
  }
  if (tab.mutedInfo?.muted) {
    indicators.push('&lt;span class="tab-indicator tab-muted"&gt;üîá&lt;/span&gt;');
  }
  if (tab.pinned) {
    indicators.push('&lt;span class="tab-indicator tab-pinned"&gt;üìå&lt;/span&gt;');
  }
  
  // Return the complete tab HTML
  return `
    &lt;div class="tab-item ${tab.active ? 'active' : ''} ${tab.pinned ? 'pinned' : ''}" 
         data-tab-id="${tab.id}" 
         data-window-id="${tab.windowId}"
         draggable="true"&gt;
      &lt;img class="tab-favicon" src="${this.escapeHtml(faviconUrl)}" alt=""&gt;
      &lt;div class="tab-info"&gt;
        &lt;div class="tab-title"&gt;${this.escapeHtml(tabTitle)}&lt;/div&gt;
        &lt;div class="tab-url"&gt;${this.escapeHtml(displayUrl)}&lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="tab-indicators"&gt;
        ${indicators.join('')}
      &lt;/div&gt;
      &lt;div class="tab-actions"&gt;
        &lt;button class="tab-btn close-tab-btn" data-tab-id="${tab.id}"&gt;
          ‚úï
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  `;
}</code></pre>
      </div>

      <div class="visual-example">
        <h4>Visual Result:</h4>
        <div class="tab-demo">
          <div class="tab-favicon"></div>
          <div class="tab-info">
            <div class="tab-title">Example Tab Title</div>
            <div class="tab-url">example.com</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drag & Drop -->
    <div class="section" id="drag-drop">
      <h2>6. Drag & Drop Implementation</h2>
      <p>The drag-and-drop system allows tabs to be moved between windows:</p>

      <h3>Drag Start:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>// When user starts dragging a tab
tabItem.addEventListener('dragstart', (e) => {
  // Store the dragged tab's data
  this.dragData = { 
    tabId: parseInt(tabItem.dataset.tabId), 
    windowId: parseInt(tabItem.dataset.windowId) 
  };
  
  // Add visual feedback
  tabItem.classList.add('dragging');
  
  // Show the drop zone for creating new windows
  this.elements.dropZone.classList.remove('hidden');
  
  // Set drag effect
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', ''); // Firefox compatibility
});</code></pre>
      </div>

      <h3>Drop Handling:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>// When tab is dropped on a window
tabsContainer.addEventListener('drop', (e) => {
  e.preventDefault();
  windowElement.classList.remove('drag-over');
  
  // Check if this is a different window
  if (this.dragData && this.dragData.windowId !== windowId) {
    // Move the tab to the new window
    this.moveTabToWindow(this.dragData.tabId, windowId);
  }
});

// The actual move operation
async moveTabToWindow(tabId, targetWindowId) {
  try {
    await this.sendMessage({ 
      action: 'moveTab', 
      data: { tabId, windowId: targetWindowId } 
    });
    
    this.showToast('Tab moved', 'success');
  } catch (error) {
    this.showToast('Failed to move tab', 'error');
  }
}</code></pre>
      </div>

      <h3>Visual Feedback During Drag:</h3>
      <ul>
        <li>Dragged tab becomes semi-transparent (<code>opacity: 0.6</code>)</li>
        <li>Target windows show blue dashed border when hovering</li>
        <li>Drop zone appears in bottom-right for creating new windows</li>
        <li>Cursor changes to indicate valid drop targets</li>
      </ul>

      <div class="highlight">
        <strong>üéØ Drop Zone Feature:</strong> When dragging a tab, a blue drop zone appears. Dropping a tab there creates a new window with that tab.
      </div>
    </div>

    <!-- Event Handling -->
    <div class="section" id="event-handling">
      <h2>7. Event Handling</h2>
      <p>The manager handles various user interactions:</p>

      <h3>Click Events:</h3>
      <div class="feature-grid">
        <div class="feature-card">
          <h4>Tab Click</h4>
          <pre><code>// Focus the clicked tab
tabItem.addEventListener('click', (e) => {
  if (!e.target.classList.contains('tab-btn')) {
    this.focusTab(tabId);
  }
});</code></pre>
        </div>
        <div class="feature-card">
          <h4>Close Button</h4>
          <pre><code>// Close tab when X is clicked
closeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  this.closeTab(tabId);
});</code></pre>
        </div>
        <div class="feature-card">
          <h4>Window Actions</h4>
          <pre><code>// Focus or close entire window
focusBtn.addEventListener('click', () => {
  this.focusWindow(windowId);
});</code></pre>
        </div>
      </div>

      <h3>Event Delegation Pattern:</h3>
      <p>For dynamically created elements, events are attached during creation:</p>
      <pre><code>setupWindowEventListeners(windowElement) {
  // Get all interactive elements
  const focusBtn = windowElement.querySelector('.focus-window-btn');
  const closeBtn = windowElement.querySelector('.close-window-btn');
  const tabItems = windowElement.querySelectorAll('.tab-item');
  
  // Attach listeners
  focusBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    this.focusWindow(parseInt(focusBtn.dataset.windowId));
  });
  
  // Setup each tab
  tabItems.forEach(tabItem => {
    this.setupTabEventListeners(tabItem);
  });
}</code></pre>
    </div>

    <!-- Real-time Updates -->
    <div class="section" id="real-time-updates">
      <h2>8. Real-time Updates</h2>
      <p>The manager stays synchronized with browser state changes:</p>

      <h3>Background Listener Setup:</h3>
      <div class="code-block">
        <span class="code-label">background.js</span>
        <pre><code>setupTabListeners() {
  // Listen for any tab/window changes
  chrome.tabs.onCreated.addListener(() => this.notifyUIUpdate());
  chrome.tabs.onRemoved.addListener(() => this.notifyUIUpdate());
  chrome.tabs.onMoved.addListener(() => this.notifyUIUpdate());
  chrome.tabs.onUpdated.addListener(() => this.notifyUIUpdate());
  chrome.windows.onCreated.addListener(() => this.notifyUIUpdate());
  chrome.windows.onRemoved.addListener(() => this.notifyUIUpdate());
}

notifyUIUpdate() {
  // Broadcast update to all open extension pages
  chrome.runtime.sendMessage({ action: 'windowsUpdated' }).catch(() => {
    // Ignore errors if no listeners
  });
}</code></pre>
      </div>

      <h3>Manager Update Handler:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>// In setupEventListeners()
chrome.runtime.onMessage.addListener((message) => {
  if (message.action === 'windowsUpdated') {
    // Reload all windows when browser state changes
    this.loadWindows();
  }
});</code></pre>
      </div>

      <div class="success">
        <strong>‚ú® Result:</strong> Any change to tabs or windows (new tab, closed tab, moved tab, etc.) automatically updates the manager UI without requiring manual refresh.
      </div>
    </div>

    <!-- Security Features -->
    <div class="section" id="security">
      <h2>9. Security Features</h2>
      <p>The manager implements several security measures:</p>

      <h3>HTML Escaping:</h3>
      <div class="code-block">
        <span class="code-label">manager.js</span>
        <pre><code>escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;  // textContent is automatically escaped
  return div.innerHTML;
}

// Usage in rendering
`&lt;div class="tab-title"&gt;${this.escapeHtml(tabTitle)}&lt;/div&gt;`</code></pre>
      </div>

      <h3>Input Validation:</h3>
      <div class="code-block">
        <span class="code-label">background.js</span>
        <pre><code>isValidTabId(tabId) {
  return typeof tabId === 'number' && 
         tabId > 0 && 
         tabId < Number.MAX_SAFE_INTEGER;
}

// Used before any Chrome API call
if (!this.isValidTabId(data.tabId)) {
  throw new Error('Invalid tab ID');
}</code></pre>
      </div>

      <h3>Message Security:</h3>
      <ul>
        <li>All messages validated in background script</li>
        <li>Only trusted actions are whitelisted</li>
        <li>No eval() or innerHTML with user data</li>
        <li>All user-generated content is escaped</li>
      </ul>

      <div class="warning">
        <strong>‚ö†Ô∏è Security Note:</strong> Never trust data from external sources. Always validate and sanitize before rendering or processing.
      </div>
    </div>

    <!-- Summary -->
    <div class="section">
      <h2>Summary</h2>
      <p>The Window & Tab Manager page provides a secure, intuitive interface for browser organization:</p>
      
      <ol>
        <li><strong>Initialization:</strong> Sets up the WindowManager class and loads browser data</li>
        <li><strong>Data Flow:</strong> Requests window/tab data through secure message passing</li>
        <li><strong>Rendering:</strong> Transforms data into visual HTML elements with proper escaping</li>
        <li><strong>Interactivity:</strong> Handles clicks, drags, and drops with visual feedback</li>
        <li><strong>Real-time Sync:</strong> Automatically updates when browser state changes</li>
        <li><strong>Security:</strong> Validates all inputs and escapes all outputs</li>
      </ol>

      <div class="success">
        <strong>üöÄ Result:</strong> A powerful, secure tab management interface that feels native and responsive, all without external dependencies or security vulnerabilities.
      </div>
    </div>
  </div>
</body>
</html>